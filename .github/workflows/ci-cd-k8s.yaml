name: CI/CD Pipeline to K3S (Production - Docker Hub)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  DOCKER_USERNAME: tdksoft341
  REGISTRY: docker.io
  IMAGE_NAME: social-media-dashboard
  IMAGE_TAG: ${{ github.sha }}
  K8S_NAMESPACE: my-app  # Match your existing namespace
  K3S_HOST: 178.254.23.139
  K3S_USERNAME: hkengne

jobs:
  build-test-and-publish:
    name: Build, Test & Push to Docker Hub
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PAT }}

      - name: Build and Push Docker Image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha

  deploy-k8s:
    name: Deploy to K3S Production
    needs: build-test-and-publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to K3S Cluster
        uses: appleboy/ssh-action@v1.0.3
        env:
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
          IMAGE_NAME: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        with:
          host: ${{ env.K3S_HOST }}
          username: ${{ env.K3S_USERNAME }}
          key: ${{ secrets.SSH_VPS_DE }}
          envs: K8S_NAMESPACE,IMAGE_NAME
          script: |
            echo "--- Starting K3S Deployment to Namespace: ${K8S_NAMESPACE} ---"
            echo "Using image: ${IMAGE_NAME}"
            
            # Verify namespace exists
            if ! kubectl get namespace "${K8S_NAMESPACE}" &> /dev/null; then
              echo "Namespace ${K8S_NAMESPACE} does not exist. Creating it..."
              kubectl create namespace "${K8S_NAMESPACE}"
            fi
            
            # Verify deployment exists
            echo "Checking for existing deployment..."
            if kubectl get deployment social-media-scrapper-deployment -n "${K8S_NAMESPACE}" &> /dev/null; then
              echo "✅ Deployment found. Updating image..."
              kubectl set image deployment/social-media-scrapper-deployment \
                social-media-scrapper="${IMAGE_NAME}" -n "${K8S_NAMESPACE}"
            else
              echo "❌ Deployment not found in namespace ${K8S_NAMESPACE}"
              echo "Please ensure your deployment manifest is applied to the correct namespace"
              exit 1
            fi
            
            echo "Deployment update triggered. Checking rollout status..."
            kubectl rollout status deployment/social-media-scrapper-deployment -n "${K8S_NAMESPACE}" --timeout=5m
            
            if [ $? -eq 0 ]; then
                echo "✅ Deployment completed successfully!"
                echo "--- Current deployment status ---"
                kubectl get deployment social-media-scrapper-deployment -n "${K8S_NAMESPACE}"
                echo "--- Pods ---"
                kubectl get pods -n "${K8S_NAMESPACE}" -l app=social-media-scrapper
                echo "--- Container images ---"
                kubectl get pods -n "${K8S_NAMESPACE}" -l app=social-media-scrapper -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
            else
                echo "❌ Deployment failed!"
                echo "--- Deployment description ---"
                kubectl describe deployment social-media-scrapper-deployment -n "${K8S_NAMESPACE}"
                echo "--- Recent events ---"
                kubectl get events -n "${K8S_NAMESPACE}" --sort-by='.lastTimestamp' | tail -10
                exit 1
            fi