name: CI/CD Pipeline to K3S via SSH

on:
  push:
    branches:
      - main
    # Exclusion : n'exécute pas le CI sur les commits automatiques faits par cette même action
    # Note: les commits automatiques faits par cette même action ne déclenchent pas de nouvelles exécutions du workflow.
    paths-ignore:
      - 'k8s/deployment.yaml' 

env:
  PYTHON_VERSION: '3.10'

  # Docker Hub Credentials and Image Info
  DOCKER_USERNAME: tdksoft341
  REGISTRY: docker.io
  IMAGE_NAME: social-media-dashboard
  IMAGE_TAG: ${{ github.sha }}
 
  # K3S and App Deployment Info
  K8S_NAMESPACE: my-app
  K3S_HOST: 178.254.23.139
  K3S_USERNAME: hkengne
  APP_DOMAIN: http://178.254.23.139

  # k8s manifests path
  K8S_MANIFESTS_PATH: k8s/

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the changed files back to the repository.
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PAT }}

      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
             ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}


  deploy:
    name: Deploy on K3S via SSH
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
          
      # 3. MISE À JOUR DU MANIFESTE (L'étape cruciale pour GitOps)
      - name: Update Deployment Manifest with New Image Tag
        uses: mikefarah/yq@v4 
        with:
          cmd: |
            # Mise à jour de l'image du conteneur 'social-media-scrapper'
            # Le chemin: spec -> template -> spec -> containers (le premier élément [0]) -> image
            NEW_TAG="${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            
            yq -i '.spec.template.spec.containers[0].image = env(NEW_TAG)' ${{ env.K8S_MANIFESTS_PATH }}deployment.yaml

      # 4. COMMIT ET PUSH LE CHANGEMENT
      - name: Commit and Push Image Tag Change
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CD: Update image tag for social-media-scrapper to ${{ github.sha }}"
          file_pattern: ${{ env.K8S_MANIFESTS_PATH }}deployment.yaml